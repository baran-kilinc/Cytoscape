<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cytoscape.js Performance Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-container {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .result {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .performance-gain {
            color: #4caf50;
            font-weight: bold;
        }
        #cy-test {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #2196f3;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <h1>Cytoscape.js Performance Test: Batch Operations vs Individual Updates</h1>
    
    <div class="test-container">
        <h2>Test Description</h2>
        <p>This test compares the performance of individual position updates vs batch operations on a set of nodes.</p>
        <p><strong>Test scenario:</strong> Moving 100 nodes to new positions</p>
    </div>

    <div class="test-container">
        <h2>Test Environment</h2>
        <div id="cy-test"></div>
        <button onclick="createTestData()">Create Test Data (100 nodes)</button>
        <button onclick="testIndividualUpdates()">Test Individual Updates (Old Method)</button>
        <button onclick="testBatchUpdates()">Test Batch Updates (New Method)</button>
        <button onclick="runComparisonTest()">Run Comparison Test</button>
    </div>

    <div class="test-container">
        <h2>Performance Results</h2>
        <div id="results"></div>
    </div>

    <script>
        let cy;
        let testResults = [];

        function initCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cy-test'),
                elements: [],
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#2196f3',
                            'label': 'data(id)',
                            'color': '#fff',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'width': 30,
                            'height': 30
                        }
                    }
                ],
                layout: { name: 'grid', rows: 10, cols: 10 }
            });
        }

        function createTestData() {
            const elements = [];
            for (let i = 0; i < 100; i++) {
                elements.push({
                    data: { id: `node-${i}` },
                    position: { x: Math.random() * 500, y: Math.random() * 300 }
                });
            }
            
            cy.elements().remove();
            cy.add(elements);
            cy.layout({ name: 'grid', rows: 10, cols: 10 }).run();
            
            updateResults("‚úÖ Created 100 test nodes");
        }

        function testIndividualUpdates() {
            const startTime = performance.now();
            
            // Simulate the old method - individual position updates
            cy.nodes().forEach(node => {
                const newPos = {
                    x: Math.random() * 500,
                    y: Math.random() * 300
                };
                node.position(newPos); // Each call triggers a redraw
            });
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            testResults.push({ method: 'Individual', time: duration });
            
            updateResults(`üêå Individual Updates: ${duration.toFixed(2)}ms`);
        }

        function testBatchUpdates() {
            const startTime = performance.now();
            
            // Simulate the new method - batch updates
            const positionUpdates = [];
            cy.nodes().forEach(node => {
                positionUpdates.push({
                    node: node,
                    position: {
                        x: Math.random() * 500,
                        y: Math.random() * 300
                    }
                });
            });
            
            // Apply all updates in a single batch
            cy.batch(() => {
                positionUpdates.forEach(update => {
                    update.node.position(update.position);
                });
            });
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            testResults.push({ method: 'Batch', time: duration });
            
            updateResults(`üöÄ Batch Updates: ${duration.toFixed(2)}ms`);
        }

        function runComparisonTest() {
            if (!cy.nodes().length) {
                updateResults("‚ùå Please create test data first");
                return;
            }

            testResults = [];
            updateResults("üß™ Running comparison test...");
            
            // Run multiple iterations for more accurate results
            const iterations = 5;
            let individualTotal = 0;
            let batchTotal = 0;
            
            for (let i = 0; i < iterations; i++) {
                // Test individual updates
                const start1 = performance.now();
                cy.nodes().forEach(node => {
                    node.position({
                        x: Math.random() * 500,
                        y: Math.random() * 300
                    });
                });
                const end1 = performance.now();
                individualTotal += (end1 - start1);
                
                // Test batch updates
                const start2 = performance.now();
                const updates = [];
                cy.nodes().forEach(node => {
                    updates.push({
                        node: node,
                        position: {
                            x: Math.random() * 500,
                            y: Math.random() * 300
                        }
                    });
                });
                cy.batch(() => {
                    updates.forEach(update => {
                        update.node.position(update.position);
                    });
                });
                const end2 = performance.now();
                batchTotal += (end2 - start2);
            }
            
            const individualAvg = individualTotal / iterations;
            const batchAvg = batchTotal / iterations;
            const improvement = ((individualAvg - batchAvg) / individualAvg * 100);
            
            updateResults(`
                üìä <strong>Comparison Results (${iterations} iterations average):</strong><br>
                üêå Individual Updates: ${individualAvg.toFixed(2)}ms<br>
                üöÄ Batch Updates: ${batchAvg.toFixed(2)}ms<br>
                <span class="performance-gain">‚ö° Performance Improvement: ${improvement.toFixed(1)}%</span><br>
                <span class="performance-gain">üéØ Batch operations are ${(individualAvg / batchAvg).toFixed(1)}x faster!</span>
            `);
        }

        function updateResults(message) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = message;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Initialize on page load
        window.onload = function() {
            initCytoscape();
            updateResults("üèÅ Performance test environment ready. Create test data to begin.");
        };
    </script>
</body>
</html>